

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Users behavior clustering &mdash; Retentioneering 2.0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Compare groups" href="compare.html" />
    <link rel="prev" title="Step_matrix function" href="step_matrix.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html">
          

          
            
            <img src="_static/rete_logo.png" class="logo" alt="Logo"/>
          
          </a>

          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">TUTORIAL:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="what_is_rete.html">What is Retentioneering?</a></li>
<li class="toctree-l1"><a class="reference internal" href="what_is_rete.html#test">TEST</a></li>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="getting_started.html">Getting started</a></li>
</ul>
<p class="caption"><span class="caption-text">CORE FUNCTIONS GUIDES:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="plot_graph.html">Plot graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="step_matrix.html">Step matrix</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Behavioral clustering</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#behavior-clustering-intro">Behavior clustering intro</a></li>
<li class="toctree-l2"><a class="reference internal" href="#basic-example">Basic example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#visualizing-results">Visualizing results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#exploring-individual-clusters">Exploring individual clusters</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="compare.html">Compare segments</a></li>
</ul>
<p class="caption"><span class="caption-text">API REFERENCE:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="retentioneering.core.html">Core functions</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Retentioneering</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Users behavior clustering</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/clustering.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="users-behavior-clustering">
<h1>Users behavior clustering<a class="headerlink" href="#users-behavior-clustering" title="Permalink to this headline">¶</a></h1>
<div class="section" id="behavior-clustering-intro">
<h2>Behavior clustering intro<a class="headerlink" href="#behavior-clustering-intro" title="Permalink to this headline">¶</a></h2>
</div>
<div class="section" id="basic-example">
<h2>Basic example<a class="headerlink" href="#basic-example" title="Permalink to this headline">¶</a></h2>
<p>This notebook can be found
<a class="reference external" href="https://github.com/retentioneering/retentioneering-tools/blob/fix_normalization_funcs/examples/clusters_tutorial.ipynb">here</a>.</p>
<p>We will use sample user activity dataset to illustrate how behavior clustering works. Let’s first
import retentioneering, import sample dataset and update config to set used column names:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">retentioneering</span>

<span class="c1"># load sample data</span>
<span class="kn">from</span> <span class="nn">retentioneering</span> <span class="kn">import</span> <span class="n">datasets</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">datasets</span><span class="o">.</span><span class="n">load_simple_shop</span><span class="p">()</span>

<span class="c1"># update config to specify column names</span>
<span class="n">retentioneering</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
    <span class="s1">&#39;event_col&#39;</span><span class="p">:</span><span class="s1">&#39;event&#39;</span><span class="p">,</span>
    <span class="s1">&#39;event_time_col&#39;</span><span class="p">:</span><span class="s1">&#39;timestamp&#39;</span><span class="p">,</span>
    <span class="s1">&#39;index_col&#39;</span><span class="p">:</span> <span class="s1">&#39;client_id&#39;</span>
<span class="p">})</span>
</pre></div>
</div>
<p>We can now use get_clusters method to split users on groups based on how similar is their behavior:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span>
                       <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                       <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">));</span>
</pre></div>
</div>
<p>Under the hood each user trajectory (sequence of event names) got transformed to numeric vector.
In the example above we used ‘ftidf’ vectorization (default vectorizer), where
vocaburary is sequences of events from 1 to 2 (parameter ngram_range), meaning that we count
individual events up to sequnces of 2 (bi-grams).</p>
<p>Parameter n_clusters corresponds to the number of desired clusters. Parameter method -
type of clusterization algorithm to use (currently support ‘kmeans’ and ‘gmm’).</p>
<p>Result of the method above is assigned to a new rete attribute: cluster_mapping, which is a
dictionary containing user_id’s for each cluster:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">cluster_mapping</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="p">[</span><span class="mi">7584012</span><span class="p">,</span>
  <span class="mi">7901023</span><span class="p">,</span>
  <span class="mi">10847418</span><span class="p">,</span>
  <span class="mi">12133064</span><span class="p">,</span>
  <span class="mi">15882438</span><span class="p">,</span>
  <span class="mi">20104222</span><span class="p">,</span>
<span class="o">...</span><span class="p">,</span>
<span class="mi">1</span><span class="p">:</span> <span class="p">[</span><span class="mi">463458</span><span class="p">,</span>
  <span class="mi">1475907</span><span class="p">,</span>
  <span class="mi">10007545</span><span class="p">,</span>
  <span class="mi">10768877</span><span class="p">,</span>
  <span class="mi">10769994</span><span class="p">,</span>
</pre></div>
</div>
<p>Now, if we need to obtain all user_id’s from a specific cluster, it can be done very easily using
cluster_mapping dictionary. For example:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clus_2</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">cluster_mapping</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
</pre></div>
</div>
<p>here, clus_2 will contain all user_id’s of users from cluster 2.</p>
</div>
<div class="section" id="visualizing-results">
<h2>Visualizing results<a class="headerlink" href="#visualizing-results" title="Permalink to this headline">¶</a></h2>
<p>Very often it is useful to have a high-level overview of the results of clusterization
immediately after clusterization was done. Clusters statistics can be shown with the
clusterization by including plot_type parameter:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span>
                       <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                       <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                       <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;cluster_bar&#39;</span><span class="p">);</span>
</pre></div>
</div>
<img alt="_images/clustering_0.svg" src="_images/clustering_0.svg" /><p>By default it shows the relative size of each cluster. We can add convertion to any specified event
to the clusters statistics using parameter targets, where we can specify target events.
High-level overview bar plot will now include convertion rate (% of users within the cluster
who have specified event at least once) for specified target:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span>
                       <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                       <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                       <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;cluster_bar&#39;</span><span class="p">,</span>
                       <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<img alt="_images/clustering_1.svg" src="_images/clustering_1.svg" /><p>Parameter targets can contain any number of events. For each added event, corresponding
convertion rate will be included to cluster overview bar plot. This is very useful when
you need to get a quick intuition about the resulting clusters:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">get_clusters</span><span class="p">(</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;kmeans&#39;</span><span class="p">,</span>
                       <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span>
                       <span class="n">ngram_range</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                       <span class="n">plot_type</span><span class="o">=</span><span class="s1">&#39;cluster_bar&#39;</span><span class="p">,</span>
                       <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;payment_done&#39;</span><span class="p">,</span><span class="s1">&#39;cart&#39;</span><span class="p">]);</span>
</pre></div>
</div>
<img alt="_images/clustering_2.svg" src="_images/clustering_2.svg" /><p>In example above we can see that clusters 0 and 7 have relatively high convertion rates to purchase
comparing to other clusters (CR: ‘payment_done’). Interestingly, cluster 4 has very high convertion
to visit ‘cart’ (same as clusters 0 and 7) but don’t have any convertions to ‘payment_done’. This
must be cluster of users who reach the cart but get lost somewhere between cart and payment_done.
This way we can immediately start buiding our intuition about resulting clusters.</p>
</div>
<div class="section" id="exploring-individual-clusters">
<h2>Exploring individual clusters<a class="headerlink" href="#exploring-individual-clusters" title="Permalink to this headline">¶</a></h2>
<p>After clusterization is done we can explore individual clusters using full arsenal of
retentioneering tools. Function filter_cluster can be used to isolate individual dataset
for a given cluster number or list of clusters:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clus_4</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">filter_cluster</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
<p>now, clus_4 is regular pandas dataframe containig only users from cluster 4. Since it is
regular pandas dataframe we can directly apply rete tools such as plot_graph or step_matrix to
explore it:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clus_4</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">plot_graph</span><span class="p">(</span><span class="n">thresh</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span>
                       <span class="n">weight_col</span><span class="o">=</span><span class="s1">&#39;client_id&#39;</span><span class="p">,</span>
                       <span class="n">targets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lost&#39;</span><span class="p">:</span><span class="s1">&#39;red&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;payment_done&#39;</span><span class="p">:</span><span class="s1">&#39;green&#39;</span><span class="p">})</span>
</pre></div>
</div>
<iframe
    width="700"
    height="600"
    src="_static/clustering/index_0.html"
    frameborder="0"
    allowfullscreen
></iframe><div class="line-block">
<div class="line"><br /></div>
</div>
<p>We can see that this cluster #4 consists of users who explore catalog, products 1 and 2, then
reach the ‘cart’, but lost after the cart. To see how users in cluster 4 get to the cart we can
plot step_matrix centered around cart:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clus_4</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">step_matrix</span><span class="p">(</span><span class="n">max_steps</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span>
                        <span class="n">centered</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;event&#39;</span><span class="p">:</span> <span class="s1">&#39;cart&#39;</span><span class="p">,</span>
                                  <span class="s1">&#39;left_gap&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">,</span>
                                  <span class="s1">&#39;occurrence&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">});</span>
</pre></div>
</div>
<img alt="_images/clustering_3.svg" src="_images/clustering_3.svg" /><p>Other clusters can be explored in a similar way. Note, that dataframe containing multiple
clusters can be extracted by passing a list of cluster numbers to filter_cluster() function.
For example, if we would like to obtain dataset only containing users from clusters 0 and 7
for subsequent analysis, we can simply do:</p>
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">clus_0_7</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">rete</span><span class="o">.</span><span class="n">filter_cluster</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">7</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="compare.html" class="btn btn-neutral float-right" title="Compare groups" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="step_matrix.html" class="btn btn-neutral float-left" title="Step_matrix function" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2020, &#34;Data Driven Lab&#34; LLC

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
    <br><br><a href="https://www.linkedin.com/in/godsie/">Maxim Godzi</a> and <a href="https://www.linkedin.com/in/anatoly-zaytsev/">Anatoly Zaytsev</a>. More information at <a href="https://retentioneering.com/">Retentioneering.com</a>.


</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    <!-- Theme Analytics -->
    <script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-143266385-2', 'auto');
    ga('send', 'pageview');
    </script>

    
   

</body>
</html>